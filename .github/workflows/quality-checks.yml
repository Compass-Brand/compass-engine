name: Quality Checks

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Pre-Push Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Basic validation
        run: |
          echo "Checking for common issues..."
          for f in CLAUDE.md .coderabbit.yaml greptile.json; do
            if [ -f "$f" ]; then
              echo "âœ“ $f exists"
            else
              echo "::warning::Missing $f"
            fi
          done

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for merge conflict markers
        run: |
          # Use more specific patterns to avoid false positives from progress bars
          if grep -rn "^<<<<<<<\|^=======\$\|^>>>>>>>" --include="*.md" --include="*.ts" --include="*.py" --include="*.json" . 2>/dev/null; then
            echo "::error::Merge conflict markers found"
            exit 1
          fi
          echo "No merge conflict markers found"

  docs-audit:
    name: Documentation Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Check documentation freshness
        run: |
          echo "Checking documentation freshness..."
          CUTOFF_DATE=$(date -d "30 days ago" +%s 2>/dev/null || date -v-30d +%s)
          STALE_DOCS=0
          for file in $(git ls-files "*.md"); do
            LAST_COMMIT=$(git log -1 --format=%ct -- "$file" 2>/dev/null || echo "0")
            if [ "$LAST_COMMIT" -lt "$CUTOFF_DATE" ]; then
              STALE_DOCS=$((STALE_DOCS + 1))
            fi
          done
          echo "Found $STALE_DOCS markdown files not updated in 30+ days"
          if [ "$STALE_DOCS" -gt 5 ]; then
            echo "::warning::Found $STALE_DOCS potentially stale documentation files"
          fi
