name: Submodule Security Monitoring

on:
  schedule:
    - cron: '30 9 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  trivy-submodule-scan:
    name: Trivy Submodule Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Run Trivy
        uses: aquasecurity/trivy-action@0.34.1
        with:
          scan-type: fs
          scan-ref: .
          scanners: vuln,misconfig,secret
          severity: HIGH,CRITICAL
          format: table
          exit-code: '1'
          ignore-unfixed: true
          skip-dirs: node_modules,dist

  monitor-bmad-method-wds-expansion:
    name: Monitor bmad-method-wds-expansion
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Compare pinned commit to upstream
        id: compare
        run: |
          set -euo pipefail
          SUBMODULE_PATH="bmad-method-wds-expansion"
          TARGET_BRANCH="$(git config --file .gitmodules --get submodule.bmad-method-wds-expansion.branch || echo main)"

          git -C "$SUBMODULE_PATH" fetch origin "$TARGET_BRANCH"

          CURRENT_SHA="$(git -C "$SUBMODULE_PATH" rev-parse HEAD)"
          UPSTREAM_SHA="$(git -C "$SUBMODULE_PATH" rev-parse "origin/$TARGET_BRANCH")"

          echo "branch=$TARGET_BRANCH" >> "$GITHUB_OUTPUT"
          echo "current_sha=$CURRENT_SHA" >> "$GITHUB_OUTPUT"
          echo "upstream_sha=$UPSTREAM_SHA" >> "$GITHUB_OUTPUT"

          if [ "$CURRENT_SHA" != "$UPSTREAM_SHA" ]; then
            echo "behind=true" >> "$GITHUB_OUTPUT"
          else
            echo "behind=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Open or update monitoring issue
        if: steps.compare.outputs.behind == 'true'
        uses: actions/github-script@v7
        env:
          TARGET_BRANCH: ${{ steps.compare.outputs.branch }}
          CURRENT_SHA: ${{ steps.compare.outputs.current_sha }}
          UPSTREAM_SHA: ${{ steps.compare.outputs.upstream_sha }}
        with:
          script: |
            const title = 'Submodule update available: bmad-method-wds-expansion';
            const body = [
              'Automated monitoring detected that `bmad-method-wds-expansion` is behind upstream.',
              '',
              `- Branch: \`${process.env.TARGET_BRANCH}\``,
              `- Pinned: \`${process.env.CURRENT_SHA.slice(0, 7)}\``,
              `- Upstream: \`${process.env.UPSTREAM_SHA.slice(0, 7)}\``,
              '',
              'Review the upstream changes and update the submodule pin if approved.'
            ].join('\n');

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const existing = issues.find((issue) => issue.title === title);

            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body
              });
            }
